# é‡æ„åæ·»åŠ æ–°äº‹ä»¶ç±»å‹ç¤ºä¾‹

## ğŸ‰ é‡æ„çš„å¥½å¤„

é‡æ„åï¼Œæ·»åŠ æ–°äº‹ä»¶ç±»å‹å˜å¾—éå¸¸ç®€å•ï¼ä»åŸæ¥çš„**å‡ ç™¾è¡Œä»£ç **å‡å°‘åˆ°åªéœ€è¦**å‡ åè¡Œé…ç½®**ã€‚

## ğŸ“ æ·»åŠ éŸ³æ•ˆäº‹ä»¶ç¤ºä¾‹

å‡è®¾æˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªéŸ³æ•ˆæ’­æ”¾äº‹ä»¶ï¼Œåªéœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š

### 1. åœ¨EventTypeRegistryä¸­æ³¨å†Œæ–°äº‹ä»¶ç±»å‹

```gdscript
# åœ¨EventTypeRegistry.gdçš„initialize_default_types()æ–¹æ³•ä¸­æ·»åŠ ï¼š

# éŸ³æ•ˆäº‹ä»¶
register_event_type("sound", {
	"display_name": "éŸ³æ•ˆäº‹ä»¶",
	"class_name": "SoundEvent",
	"ui_fields": [
		{
			"name": "sound_path",
			"type": "resource_picker",
			"label": "éŸ³æ•ˆæ–‡ä»¶:",
			"resource_type": "AudioStream",
			"placeholder": "res://assets/sounds/your_sound.ogg"
		},
		{
			"name": "volume",
			"type": "spin_box",
			"label": "éŸ³é‡:",
			"default": 1.0,
			"min_value": 0.0,
			"max_value": 2.0,
			"step": 0.1
		},
		{
			"name": "pitch",
			"type": "spin_box",
			"label": "éŸ³è°ƒ:",
			"default": 1.0,
			"min_value": 0.5,
			"max_value": 2.0,
			"step": 0.1
		},
		{
			"name": "wait_for_completion",
			"type": "check_box",
			"label": "ç­‰å¾…æ’­æ”¾å®Œæˆ",
			"default": false
		}
	],
	"button_text": {
		"add": "æ·»åŠ éŸ³æ•ˆäº‹ä»¶",
		"update": "æ›´æ–°éŸ³æ•ˆäº‹ä»¶"
	}
})
```

### 2. åˆ›å»ºSoundEventç±»

```gdscript
# æ–‡ä»¶: addons/narrative_editor/core/events/SoundEvent.gd
class_name SoundEvent
extends EventData

@export var sound_path: String = ""
@export var volume: float = 1.0
@export var pitch: float = 1.0
@export var wait_for_completion: bool = false

func _init(p_id: String = "", path: String = ""):
	super._init(p_id, "sound")
	sound_path = path

func execute(executor) -> bool:
	print("æ’­æ”¾éŸ³æ•ˆ: ", sound_path)
	executor.play_sound(sound_path, volume, pitch)
	return true

func is_blocking() -> bool:
	return wait_for_completion

func get_description() -> String:
	var filename = sound_path.get_file()
	return "æ’­æ”¾éŸ³æ•ˆ: %s (éŸ³é‡: %.1f)" % [filename, volume]
```

### 3. åœ¨EventExecutorä¸­æ·»åŠ æ’­æ”¾æ–¹æ³•

```gdscript
# åœ¨EventExecutor.gdä¸­æ·»åŠ ï¼š
func play_sound(sound_path: String, volume: float = 1.0, pitch: float = 1.0):
	print("ğŸ”Š æ’­æ”¾éŸ³æ•ˆ: ", sound_path)
	
	if FileAccess.file_exists(sound_path):
		var audio_stream = load(sound_path) as AudioStream
		if audio_stream:
			var audio_player = AudioStreamPlayer.new()
			audio_player.stream = audio_stream
			audio_player.volume_db = linear_to_db(volume)
			audio_player.pitch_scale = pitch
			
			get_tree().current_scene.add_child(audio_player)
			audio_player.play()
			
			# å¦‚æœéœ€è¦ç­‰å¾…æ’­æ”¾å®Œæˆ
			audio_player.finished.connect(_on_sound_completed)
		else:
			print("âŒ æ— æ³•åŠ è½½éŸ³æ•ˆæ–‡ä»¶")
			_on_sound_completed()
	else:
		print("âŒ éŸ³æ•ˆæ–‡ä»¶ä¸å­˜åœ¨: ", sound_path)
		_on_sound_completed()

func _on_sound_completed():
	print("éŸ³æ•ˆæ’­æ”¾å®Œæˆï¼Œç»§ç»­ä¸‹ä¸€ä¸ªäº‹ä»¶")
	current_event_index += 1
	execute_next_event()
```

### 4. åœ¨NarrativeEngineä¸­æ·»åŠ è§£æ

```gdscript
# åœ¨NarrativeEngine.gdçš„load_events_from_file()æ–¹æ³•ä¸­æ·»åŠ ï¼š
elif event_dict.type == "sound":
	var sound_event = SoundEvent.new("editor_event_" + str(events.size()), event_dict.sound_path)
	sound_event.volume = event_dict.get("volume", 1.0)
	sound_event.pitch = event_dict.get("pitch", 1.0)
	sound_event.wait_for_completion = event_dict.get("wait_for_completion", false)
	
	events.append(sound_event)
	print("è§£æéŸ³æ•ˆäº‹ä»¶: ", event_dict.sound_path)
```

### 5. åœ¨é‡æ„ç‰ˆç¼–è¾‘å™¨ä¸­æ·»åŠ æ˜¾ç¤ºæ–‡æœ¬

```gdscript
# åœ¨narrative_editor_main_refactored.gdçš„_get_event_display_text()æ–¹æ³•ä¸­æ·»åŠ ï¼š
"sound":
	var filename = event.sound_path.get_file()
	return "[%d] æ’­æ”¾éŸ³æ•ˆ: %s (éŸ³é‡: %.1f)" % [index, filename, event.volume]
```

## âœ… å®Œæˆï¼

å°±è¿™æ ·ï¼Œä¸€ä¸ªå®Œæ•´çš„éŸ³æ•ˆäº‹ä»¶ç±»å‹å°±æ·»åŠ å®Œæˆäº†ï¼

**é‡æ„å‰**ï¼šéœ€è¦ä¿®æ”¹5-6ä¸ªæ–‡ä»¶ï¼Œæ·»åŠ å‡ ç™¾è¡Œä»£ç 
**é‡æ„å**ï¼šåªéœ€è¦åœ¨æ³¨å†Œè¡¨ä¸­é…ç½®ï¼Œåˆ›å»ºäº‹ä»¶ç±»ï¼Œæ·»åŠ å°‘é‡æ‰§è¡Œé€»è¾‘

## ğŸš€ æ›´å¤šäº‹ä»¶ç±»å‹ç¤ºä¾‹

### ç­‰å¾…äº‹ä»¶
```gdscript
register_event_type("wait", {
	"display_name": "ç­‰å¾…äº‹ä»¶",
	"class_name": "WaitEvent",
	"ui_fields": [
		{
			"name": "duration",
			"type": "spin_box",
			"label": "ç­‰å¾…æ—¶é—´(ç§’):",
			"default": 1.0,
			"min_value": 0.1,
			"max_value": 10.0,
			"step": 0.1
		}
	],
	"button_text": {
		"add": "æ·»åŠ ç­‰å¾…äº‹ä»¶",
		"update": "æ›´æ–°ç­‰å¾…äº‹ä»¶"
	}
})
```

### èƒŒæ™¯åˆ‡æ¢äº‹ä»¶
```gdscript
register_event_type("background", {
	"display_name": "èƒŒæ™¯äº‹ä»¶",
	"class_name": "BackgroundEvent",
	"ui_fields": [
		{
			"name": "background_path",
			"type": "resource_picker",
			"label": "èƒŒæ™¯å›¾ç‰‡:",
			"resource_type": "Texture2D"
		},
		{
			"name": "transition_type",
			"type": "line_edit",
			"label": "è¿‡æ¸¡æ•ˆæœ:",
			"default": "fade"
		},
		{
			"name": "transition_duration",
			"type": "spin_box",
			"label": "è¿‡æ¸¡æ—¶é•¿(ç§’):",
			"default": 1.0,
			"min_value": 0.0,
			"max_value": 5.0,
			"step": 0.1
		}
	],
	"button_text": {
		"add": "æ·»åŠ èƒŒæ™¯äº‹ä»¶",
		"update": "æ›´æ–°èƒŒæ™¯äº‹ä»¶"
	}
})
```

## ğŸ¯ é‡æ„çš„æ ¸å¿ƒä¼˜åŠ¿

1. **é…ç½®é©±åŠ¨** - æ–°äº‹ä»¶ç±»å‹åªéœ€é…ç½®ï¼Œä¸éœ€è¦ä¿®æ”¹UIä»£ç 
2. **è‡ªåŠ¨ç”Ÿæˆ** - UIç•Œé¢å®Œå…¨è‡ªåŠ¨ç”Ÿæˆï¼ŒåŒ…æ‹¬ç¼–è¾‘åŠŸèƒ½
3. **ç»Ÿä¸€ç®¡ç†** - æ‰€æœ‰äº‹ä»¶ç±»å‹åœ¨ä¸€ä¸ªåœ°æ–¹ç®¡ç†
4. **æ˜“äºæ‰©å±•** - æ·»åŠ æ–°å­—æ®µç±»å‹ä¹Ÿå¾ˆç®€å•
5. **ä»£ç å¤ç”¨** - å¤§é‡é€»è¾‘å¯ä»¥å¤ç”¨ï¼Œå‡å°‘é‡å¤ä»£ç 

ä»åŸæ¥çš„**1100+è¡Œ**å‡å°‘åˆ°**400+è¡Œæ ¸å¿ƒä»£ç **ï¼Œå¯ç»´æŠ¤æ€§å¤§å¤§æå‡ï¼ 